version: "3.8"

services:
  video-generator:
    build:
      context: .
      dockerfile: Dockerfile
    container_name: video-generator
    restart: unless-stopped
    ports:
      - "${PORT:-3000}:3000"
    environment:
      - NODE_ENV=production
      - PORT=3000
      - HOST=0.0.0.0
      - ELEVEN_LABS_API_KEY=${ELEVEN_LABS_API_KEY}
      - GOOGLE_API_KEY=${GOOGLE_API_KEY:-}
      - MAX_FILE_SIZE_MB=${MAX_FILE_SIZE_MB:-500}
      - MAX_VIDEO_DURATION=${MAX_VIDEO_DURATION:-300}
    volumes:
      # Persistent storage
      - ./storage/templates:/app/storage/templates
      - ./storage/characters:/app/storage/characters
      - ./storage/output:/app/storage/output
      # Processing is ephemeral, no need to persist
    healthcheck:
      test:
        [
          "CMD",
          "wget",
          "--no-verbose",
          "--tries=1",
          "--spider",
          "http://localhost:3000/health",
        ]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 10s
    deploy:
      resources:
        limits:
          cpus: "2"
          memory: 4G
        reservations:
          cpus: "0.5"
          memory: 512M
    logging:
      driver: "json-file"
      options:
        max-size: "10m"
        max-file: "3"
# Optional: Add Redis for production job queue
# services:
#   redis:
#     image: redis:7-alpine
#     restart: unless-stopped
#     volumes:
#       - redis_data:/data

# volumes:
#   redis_data:
